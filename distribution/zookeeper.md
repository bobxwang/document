##### 核心原理

原子广播，此机制保证了各 Server 间的同步，实现此机制的协议叫做 ZAB 协议，其有两种模式，恢复模式(选主)跟广播模式(同步)。为保证事务顺序一致性，ZK 采用递增的事务ID(zxid)号来标识。

##### ZooKeeper Atomic Broadcast

> ZAB 原子协议, 要么全部成功要么全部失败 
> 
> ZK是CP，即任何时刻对ZK的访问请求都得到一致的数据结果，但不保证每次服务请求的可用性(极端情况下ZK可能会丢弃一些请求，消费者需重新请求才能获得结果)
> 
> Eureka 保证它能够做为 Service 发现服务，相对ZK来讲它剔除了Leader节点的选取跟事务日志机制

##### 脑裂

> 两台主机互相竞争的情况

###### zk如何解决?

1. zk作为第三方集群参与到主备节点,当主备启动时在zk上竞争创建一个临时锁节点,成功则为主机其余为备机
2. 所有备机监听该临时锁节点,一旦主机与zk间session失效,则临时节点被删除
3. 一旦临时节点被删除备机开始重新申请创建临时锁节点,重新急用为主机
4. 在主机争节点后对根节点做一个ACL权限控制,则其它机器由于无法更新临时锁节点只有放弃成为备机 

##### 如何保证数据一致性

- ZAB 协议 
  - 崩溃恢复
  - 消息广播
- 两阶段提交/过半写 
- 消息有编号，由高32位跟低32位组成，高32位用来体现是否发生过 leader 切换，低 32 位是消息顺序

##### 角色

* Leader

  领导者负责进行投票的发起跟决议，更新系统状态，只有它接受写处理

* follower

  接收客户请求并向客户端返回结果，参与选主过程

* observer

  接收客户请求，但会将写请求转给 leader，不参加投票，只同步 leader 状态

##### Znode

> 每个znode创建时都会带有一个ACL列表,用于决定谁可以对它执行何种操作，节点存放数据上限

* PERSISTENT
* PERSISTENT_SEQUENTIAL
* EPHEMERAL 临时节点不能有子节点 
* EPHEMERAL_SEQUENTIAL